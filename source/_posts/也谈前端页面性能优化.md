---
title: 也谈前端页面性能优化
catalog: true
date: 2019-10-09 17:55:11
subtitle:
header-img:
tags:
---

说优化，这里主要是指减少浏览器从发起页面请求到页面加载结束的时间以及优化体验，总不能用户都在5G网络下了，咱的页面还是磕磕绊绊地蹦出来的感觉，要符合、最好是超过用户预期嘛。

这里分两个阶段来说，加载阶段 和 交互阶段。加载阶段是指资源请求、浏览器处理到第一次呈现给读者的阶段。交互阶段就是指内容有了之后的使用阶段。（什么？不知道浏览器网页从输入地址到页面呈现经历了哪些阶段？好吧，知乎搜一下）

### 加载阶段

浏览器请求了页面骨架文件，也就是html文件，并收到了响应之后，渲染进程开始工作，把html文本通过分词器解析成树状对象结构，可以理解为一个深层结构的对象。也叫DOM结构的解析。

其中若有js\css\image\media等资源文件，会按照地址发请求获取，当然这里是有优先级的，js/css 影响主体呈现的优先请求。

遇到JS会阻塞DOM解析。当dom 解析的过程中遇到了 script 标签，此时会暂停DOM的解析，把主线程让给JS引擎来执行。为什么？因为它两逻辑上不能并行。比如，假设js里做了DOM操作，修改了DOM结构，如果并行，DOM解析即使受到修改DOM的指令，上下文已经和执行JS时刻的不一样了，引入不确定性。

CSSOM是指CSS文件的对象模型。CSSOM和DOM结构，构建布局树，经GPU渲染合成图片显示给屏幕。

CSS、JS属于阻塞网页首次渲染的关键资源，media资源不算。

两个影响首次渲染的核心因素：

1. 关键资源个数。js\css 资源越多，首页的加载时间越过。
2. 关键资源的大小。越大，执行也就越慢。越大，网络请求也就越慢。一个HTTP请求的数据包在14k，大文件需要多个数据包来传输。




### 交互阶段

我们看到的网页是一帧帧的图片，就和视频一样。哪怕是一个静态网页，显示器也是以60帧/秒的速度不断刷新图片，对于眼球来说好像没动一样。对于CSS动画，这里有一些交互上的注意。因为显示的图片，后天就需要不断合成新的图片以供显示器消费。这个过程中尽量避免重排、重绘计算重的操作，如果计算不过来就会有卡顿的感觉。另外还有一个css实现的形变，比如transform属性触发，这个过程是在合成线程中实现，不会重排重绘，相比改变div的width\height属性，这种效率高的多。效率高意味着合成帧图像快，流畅。

几个建议：

减少js脚本执行时间。js脚本不要一次性占用主线程太多时间，要把主线程时不时让出来，耗时的任务可以考虑web workers.

避免强制同步执行。什么是强制同步？举个例子:
```javascript
    function foo(){
        let html = '<div>新数据</div>';
        let main_dom = document.getElementById('main')
        main_dom.innerHTML = html
        console.log(main_dom.offsetWidth)
    }
```
main_dom里刚插入了新的元素，紧接着下一句就要获取offsetWidth,那就得立即执行布局操作。而DOM操作很耗时，占用了主线程的执行时间。
